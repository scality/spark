---

- name: Ensure sidecar config and log directories exist
  file:
    state: directory
    path: "{{ item }}"
  with_items:
    - /etc/scality/spark/sidecar
    - /var/log/scality/spark/sidecar

- name: Deploy sidecar config
  template:
    src: ./sidecar-nginx.conf.j2
    dest: /etc/scality/spark/sidecar/nginx.conf
    mode: 0640

- name: deploy the sidecar container.
  shell: |
    docker run -dit --rm \
      --net host \
      --name sidecar \
      -v /var/log/scality/spark/sidecar:/logs/:rw \
      -v /etc/scality/spark/sidecar/nginx.conf:/etc/nginx/nginx.conf:ro \
      {{ nginx_container_image }}